<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‹±æ¤œå˜èªå­¦ç¿’ãƒã‚¹ã‚¿ãƒ¼</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š & iPhone 17 Pro æœ€é©åŒ– --- */
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #f0f2f5;
        }

        body, button, .card {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: #333;
        }

        /* --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }
        .active { display: flex; }

        /* --- ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        #card-container {
            width: 340px; height: 420px; margin-bottom: 25px;
            perspective: 1000px;
        }
        .card {
            width: 100%; height: 100%;
            background: white; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        .en-text { font-size: 44px; font-weight: bold; margin-bottom: 10px; padding: 0 20px; word-break: break-word; }
        .cat-text { font-size: 16px; color: #888; margin-bottom: 40px; }
        .ja-text { font-size: 32px; font-weight: bold; color: var(--danger-color); display: none; padding: 0 20px; }
        .hint-text { font-size: 16px; color: #bbb; }

        /* --- æ“ä½œãƒœã‚¿ãƒ³ --- */
        .controls { width: 340px; display: flex; gap: 15px; }
        .action-btn {
            flex: 1; height: 75px; border-radius: 38px; font-size: 20px;
            border: none; font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: opacity 0.1s;
        }
        .action-btn:active { opacity: 0.8; }
        .btn-check { background-color: var(--warning-color); }
        .btn-master { background-color: var(--success-color); }

        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ --- */
        .main-btn {
            width: 280px; padding: 20px 0; border-radius: 35px; font-size: 20px;
            margin-bottom: 15px; border: none; color: white; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .bg-30 { background: var(--primary-color); }
        .bg-25 { background: #e67e22; }
        .bg-20 { background: var(--success-color); }
        
        .list-btn {
            width: 280px; padding: 15px 0; border-radius: 35px;
            background: white; border: 2px solid #ddd; color: #555; font-size: 18px;
            margin-top: 15px; cursor: pointer;
        }

        /* --- ãƒªã‚¹ãƒˆç”»é¢ --- */
        #mastered-list { width: 100%; overflow-y: auto; flex: 1; background: white; }
        .list-item {
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-en { font-size: 24px; font-weight: bold; color: #333; }
        .list-ja { font-size: 18px; color: #666; text-align: right; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">è‹±æ¤œãƒã‚¹ã‚¿ãƒ¼</div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="screen-title" class="screen active">
        <h1 style="font-size: 36px; margin-bottom: 40px;">è‹±å˜èªå­¦ç¿’</h1>
        <button class="main-btn bg-30" onclick="startSession('30')">è‹±æ¤œ 3 ç´š</button>
        <button class="main-btn bg-25" onclick="startSession('25')">è‹±æ¤œ æº– 2 ç´š</button>
        <button class="main-btn bg-20" onclick="startSession('20')">è‹±æ¤œ 2 ç´š</button>
        <button class="list-btn" onclick="showMasteredList()">è¦šãˆãŸãƒªã‚¹ãƒˆ</button>
        
        <label style="margin-top:30px; color:#666; font-size: 18px; display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="speech-toggle" checked style="transform: scale(1.5);"> éŸ³å£°èª­ã¿ä¸Šã’
        </label>
        
        <div style="position: absolute; bottom: 50px; font-size: 14px; color: #bbb; cursor: pointer; text-decoration: underline;" onclick="resetData()">
            å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div id="card-container">
            <div class="card" id="card-face" onclick="revealAnswer()">
                <div class="en-text" id="q-en"></div>
                <div class="cat-text" id="q-cat"></div>
                <div class="hint-text" id="hint-msg">ã‚¿ãƒƒãƒ—ã—ã¦æ„å‘³ã‚’è¡¨ç¤º</div>
                <div class="ja-text" id="q-ja"></div>
            </div>
        </div>
        <div class="controls">
            <button class="action-btn btn-check" onclick="handleAnswer(false)">ã¾ã ...</button>
            <button class="action-btn btn-master" onclick="handleAnswer(true)">è¦šãˆãŸï¼</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
        <h2 style="font-size: 32px; margin-bottom: 40px;">10å•ã‚¯ãƒªã‚¢ï¼</h2>
        <button class="main-btn" id="btn-continue" onclick="startSession(selectedGrade)">ã¤ã¥ã‘ã‚‹</button>
        <div style="margin-top:30px; color:var(--primary-color); font-weight:bold; cursor:pointer; font-size: 18px;" onclick="goHome()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</div>
    </div>

    <div id="screen-list" class="screen" style="justify-content: flex-start; background: white;">
        <div style="width: 100%; padding: 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;">
            <h2 style="margin:0; font-size: 24px;">è¦šãˆãŸå˜èª</h2>
            <div id="master-count" style="font-weight:bold; color:var(--success-color); font-size: 22px;">0èª</div>
        </div>
        <div id="mastered-list"></div>
        <button class="list-btn" onclick="goHome()" style="margin: 25px; width: calc(100% - 50px);">æˆ»ã‚‹</button>
    </div>

<script>
    let myData = {}; 
    let sessionQueue = []; 
    let currentWordIndex = 0;
    let isAnswerShown = false;
    let selectedGrade = '30';
    const GRADE_DATA = { '30': [], '25': [], '20': [] };

    window.onload = async function() {
        loadUserData();
        try {
            await Promise.all([
                loadCSV('30', 'Eiken_30.csv'),
                loadCSV('25', 'Eiken_25.csv'),
                loadCSV('20', 'Eiken_20.csv')
            ]);
            document.getElementById('loading').style.display = 'none';
        } catch (e) {
            console.error(e);
            alert("CSVãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¨é…ç½®å ´æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    };

    async function loadCSV(gradeKey, fileName) {
        const res = await fetch(fileName);
        if (!res.ok) throw new Error(`${fileName} not found`);
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        
        GRADE_DATA[gradeKey] = lines.map((line, index) => {
            // ã‚«ãƒ³ãƒã‚’å«ã‚€æ—¥æœ¬èªè¨³ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€ç°¡æ˜“çš„ãªãƒ‘ãƒ¼ã‚¹å‡¦ç†
            const p = line.split(',');
            if (p.length < 3) return null;
            return { 
                id: p[0].trim() || `idx_${index}`, // IDãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                en: p[1].trim(), 
                ja: p[2].trim(), 
                cat: p[3] ? p[3].trim() : "" 
            };
        }).filter(v => v);
    }

    function loadUserData() {
        const saved = localStorage.getItem('eiken_pro_v1');
        if (saved) {
            try {
                myData = JSON.parse(saved);
            } catch(e) {
                myData = {};
            }
        }
    }

    function saveData() {
        localStorage.setItem('eiken_pro_v1', JSON.stringify(myData));
    }

    // è¤‡åˆã‚­ãƒ¼ç”Ÿæˆï¼ˆç´šã‚’ã¾ãŸãIDé‡è¤‡å¯¾ç­–ï¼‰
    function getWordKey(grade, id) {
        return `${grade}_${id}`;
    }

    function startSession(grade) {
        selectedGrade = grade;
        const targetList = GRADE_DATA[grade];
        if (!targetList || targetList.length === 0) return;

        // ãƒœã‚¿ãƒ³è‰²ã‚’åŒæœŸ
        document.getElementById('btn-continue').className = `main-btn bg-${grade}`;

        // ãƒ—ãƒ¼ãƒ«åˆ†ã‘
        let p0 = [], p1 = [], p2 = [];
        targetList.forEach(w => {
            const key = getWordKey(grade, w.id);
            const u = myData[key];
            if (!u || u.level === 0) p0.push(w);
            else if (u.level === 1) p1.push(w);
            else if (u.level === 2) p2.push(w);
        });

        [p0, p1, p2].forEach(p => p.sort(() => Math.random() - 0.5));

        // 10å•ã®æ§‹æˆ (æœªç¿’å¾—å„ªå…ˆ)
        let picked = [];
        picked = picked.concat(p0.splice(0, 7)); 
        
        let slot1 = p1.splice(0, 2);
        while(slot1.length < 2 && p0.length > 0) slot1.push(p0.shift());
        picked = picked.concat(slot1);

        let slot2 = p2.splice(0, 1);
        if(slot2.length < 1 && p1.length > 0) slot2.push(p1.shift());
        if(slot2.length < 1 && p0.length > 0) slot2.push(p0.shift());
        picked = picked.concat(slot2);

        sessionQueue = picked.filter(v => v);
        if (sessionQueue.length === 0) { 
            alert("ã“ã®ç´šã®å…¨å˜èªã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸï¼"); 
            return; 
        }
        
        currentWordIndex = 0;
        changeScreen('screen-quiz');
        showQuestion();
    }

    function showQuestion() {
        const word = sessionQueue[currentWordIndex];
        isAnswerShown = false;
        
        const enEl = document.getElementById('q-en');
        // æ–‡å­—æ•°ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¾®èª¿æ•´
        enEl.style.fontSize = word.en.length > 15 ? '32px' : '44px';
        enEl.textContent = word.en;
        
        document.getElementById('q-cat').textContent = word.cat ? `[${word.cat}]` : '';
        document.getElementById('q-ja').textContent = word.ja;
        document.getElementById('q-ja').style.display = 'none';
        document.getElementById('hint-msg').style.display = 'block';
        
        if (document.getElementById('speech-toggle').checked) speak(word.en);
    }

    function revealAnswer() {
        if(!isAnswerShown) {
            document.getElementById('q-ja').style.display = 'block';
            document.getElementById('hint-msg').style.display = 'none';
            isAnswerShown = true;
        }
    }

    function handleAnswer(isCorrect) {
        const word = sessionQueue[currentWordIndex];
        const key = getWordKey(selectedGrade, word.id);
        const u = myData[key] || { level: 0 };

        if (isCorrect) {
            // ãƒ¬ãƒ™ãƒ«3ã§ã€Œãƒã‚¹ã‚¿ãƒ¼ã€ã¨ã—ã€æœ€å¤§4ã¾ã§ä¿æŒ
            myData[key] = { level: Math.min((u.level || 0) + 1, 4) };
        } else {
            // é–“é•ãˆãŸã‚‰ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ€å¾Œã«å†å‡ºé¡Œ
            myData[key] = { level: 0 };
            sessionQueue.push(word);
        }
        
        saveData();
        currentWordIndex++;
        
        if (currentWordIndex < sessionQueue.length) {
            showQuestion();
        } else {
            changeScreen('screen-result');
        }
    }

    function showMasteredList() {
        const container = document.getElementById('mastered-list');
        container.innerHTML = '';
        let count = 0;

        Object.keys(GRADE_DATA).forEach(grade => {
            GRADE_DATA[grade].forEach(w => {
                const key = getWordKey(grade, w.id);
                const u = myData[key];
                if (u && u.level >= 3) {
                    count++;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-en">${w.en}</div>
                        <div class="list-ja">${w.ja}</div>
                    `;
                    container.appendChild(div);
                }
            });
        });

        document.getElementById('master-count').textContent = count + "èª";
        if(count === 0) {
            container.innerHTML = '<p style="text-align:center; padding:100px 20px; color:#ccc; font-size:18px;">ãƒã‚¹ã‚¿ãƒ¼ã—ãŸå˜èªã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œè¦šãˆãŸï¼ã€ã‚’3å›ç¹°ã‚Šè¿”ã™ã¨ã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>';
        }
        changeScreen('screen-list');
    }

    function changeScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goHome() { changeScreen('screen-title'); }

    function speak(text) {
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'en-US';
        uttr.rate = 0.9; // å°‘ã—ã‚†ã£ãã‚Šã‚ã«å†ç”Ÿ
        window.speechSynthesis.speak(uttr);
    }

    function resetData() {
        if(confirm("ã“ã‚Œã¾ã§ã®å­¦ç¿’è¨˜éŒ²ï¼ˆãƒã‚¹ã‚¿ãƒ¼ã—ãŸå˜èªãªã©ï¼‰ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('eiken_pro_v1');
            location.reload();
        }
    }
</script>
</body>
</html>
